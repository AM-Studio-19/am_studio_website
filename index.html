<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AM Beauty Studio | å°ˆå±¬éœ§çœ‰éœ§å”‡è¨­è¨ˆ</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = { corePlugins: { preflight: false } }
    </script>

    <style>
        /* --- æ ¸å¿ƒè®Šæ•¸ --- */
        :root {
            --primary: #D6BFA8;   /* å¥¶èŒ¶æ£• */
            --primary-dark: #C4A488;
            --secondary: #E6C2C2; /* ç«ç‘°ç²‰ */
            --text: #5A483F;      /* æ·±å’–å­— */
            --text-light: #8D7B72;
            --bg-color: #F9F8F6;  
            --card-shadow: 0 10px 30px -10px rgba(214, 191, 168, 0.4);
            --nav-height: 70px;
        }

        body {
            background-color: var(--bg-color);
            background-image: url('bg.jpg');
            background-size: cover;
            background-attachment: fixed;
            color: var(--text);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0; padding: 0;
            padding-bottom: calc(var(--nav-height) + 40px);
            -webkit-font-smoothing: antialiased;
            scroll-behavior: smooth;
        }

        /* --- å°è¦½åˆ— --- */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; width: 100%;
            height: var(--nav-height);
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            box-shadow: 0 -5px 20px rgba(0,0,0,0.05);
            display: flex; justify-content: space-around; align-items: center;
            z-index: 1000; padding-bottom: env(safe-area-inset-bottom);
        }
        .nav-btn {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: #ccc; text-decoration: none; font-size: 0.7rem; gap: 4px;
            width: 25%; height: 100%; transition: 0.3s;
        }
        .nav-btn svg { width: 24px; height: 24px; stroke: currentColor; stroke-width: 2; fill: none; transition: 0.3s; }
        .nav-btn.active { color: var(--text); }
        .nav-btn.active svg { stroke: var(--primary-dark); fill: rgba(214, 191, 168, 0.2); }

        /* --- Hero & Profile --- */
        .hero-section {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white; padding: 50px 20px 80px 20px; text-align: center; 
            border-radius: 0 0 40px 40px; position: relative; z-index: 1;
            box-shadow: 0 15px 30px -10px rgba(196, 164, 136, 0.6); overflow: hidden;
        }
        .hero-section::before {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-image: url("data:image/svg+xml,%3Csvg width='40' height='40' viewBox='0 0 40 40' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%23ffffff' fill-opacity='0.1' fill-rule='evenodd'%3E%3Cpath d='M0 40L40 0H20L0 20M40 40V20L20 40'/%3E%3C/g%3E%3C/svg%3E");
            opacity: 0.3;
        }
        .hero-title { margin: 0; font-size: 1.8rem; font-weight: 800; letter-spacing: 2px; text-shadow: 0 2px 4px rgba(0,0,0,0.1); position: relative; z-index: 1; }
        .hero-subtitle { display: inline-block; margin: 10px 0 0 0; background: rgba(255,255,255,0.2); padding: 4px 15px; border-radius: 20px; font-size: 0.9rem; backdrop-filter: blur(4px); position: relative; z-index: 1; }
        
        .profile-card {
            background: #fff; border-radius: 20px; padding: 20px; width: 85%; max-width: 500px; 
            margin: -50px auto 20px auto; box-shadow: 0 15px 30px -5px rgba(0,0,0,0.1);
            display: flex; align-items: center; gap: 15px; position: relative; z-index: 10;
        }
        .profile-img { width: 70px; height: 70px; border-radius: 50%; object-fit: cover; border: 3px solid var(--bg-color); flex-shrink: 0; background: #eee; }
        .profile-info h3 { margin: 0; font-size: 1.1rem; color: var(--text); font-weight: 700; }
        .profile-info p { margin: 4px 0 0 0; font-size: 0.8rem; color: #888; line-height: 1.4; }
        .tags-row { display: flex; gap: 5px; margin-top: 8px; flex-wrap: wrap; }
        .tag-pill { font-size: 0.65rem; background: #F2F0EB; color: #8D7B72; padding: 2px 8px; border-radius: 4px; }

        .container { max-width: 600px; margin: 0 auto; padding: 0 20px; }
        .section-header { text-align: center; margin: 40px 0 20px 0; display: flex; align-items: center; justify-content: center; gap: 15px; cursor: pointer; user-select: none; }
        .section-header h2 { font-size: 1.25rem; font-weight: 700; color: var(--text); margin: 0; letter-spacing: 1px; display: flex; align-items: center; gap: 8px; }
        .section-header::before, .section-header::after { content: ''; display: block; width: 30px; height: 1px; background: var(--primary); opacity: 0.5; }
        .header-arrow { transition: transform 0.3s ease; font-size: 0.8rem; opacity: 0.6; }
        .section-header.collapsed .header-arrow { transform: rotate(-90deg); }

        /* --- 1. è£œè‰²æŸ¥è©¢ --- */
        .search-container { background: #fff; border-radius: 24px; padding: 30px 25px; box-shadow: var(--card-shadow); text-align: center; margin-top: 10px; }
        .search-icon-box { width: 60px; height: 60px; background: #FFF5F5; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 15px auto; color: var(--secondary); }
        .input-group { position: relative; margin-top: 20px; }
        .search-input { width: 100%; padding: 16px 20px 16px 45px; font-size: 1rem; border: 1px solid #eee; border-radius: 16px; background-color: #FAFAFA; outline: none; transition: 0.3s; color: var(--text); box-sizing: border-box; }
        .search-input:focus { background-color: #fff; border-color: var(--primary); }
        .input-icon { position: absolute; left: 16px; top: 50%; transform: translateY(-50%); color: #ccc; }
        .btn-primary { display: block; width: 100%; padding: 16px 0; background: linear-gradient(135deg, #E6C2C2 0%, #Dcb0b0 100%); color: #fff; border-radius: 16px; font-weight: 700; font-size: 1.05rem; margin-top: 15px; cursor: pointer; border: none; box-shadow: 0 4px 15px rgba(230, 194, 194, 0.4); transition: 0.3s; }
        .btn-primary:active { transform: scale(0.98); }

        .result-card { background: white; border-radius: 20px; padding: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.06); margin-bottom: 20px; border: 1px solid rgba(0,0,0,0.02); animation: slideUp 0.5s ease; }
        .result-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .result-name { font-size: 1.2rem; font-weight: 700; color: var(--text); }
        .info-badges { display: flex; gap: 10px; margin-bottom: 15px; }
        .info-badge { flex: 1; background: #F9F8F6; padding: 10px; border-radius: 12px; text-align: center; border: 1px solid #eee; }
        .info-label { display: block; font-size: 0.75rem; color: #999; margin-bottom: 4px; }
        .info-value { display: block; font-size: 1rem; font-weight: 700; color: var(--text); }
        .info-value.highlight { color: #C17E7E; }

        /* --- 2. æœå‹™é …ç›® --- */
        .service-list-text { display: flex; flex-direction: column; gap: 12px; }
        .service-card { background: rgba(255,255,255,0.8); backdrop-filter: blur(5px); padding: 18px 20px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.6); display: flex; justify-content: space-between; align-items: center; cursor: pointer; transition: 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.02); }

        /* --- 3. ç•™è‰²ä½œå“ (æ©«å‘) --- */
        .section-collapsible { transition: max-height 0.4s ease, opacity 0.4s ease; overflow: hidden; opacity: 1; max-height: 2000px; }
        .section-collapsible.collapsed { max-height: 0; opacity: 0; }
        .filter-scroller { display: flex; gap: 10px; overflow-x: auto; justify-content: center; margin-bottom: 20px; padding-bottom: 5px;}
        .filter-chip { padding: 6px 16px; border-radius: 20px; font-size: 0.85rem; background: rgba(255,255,255,0.6); color: var(--text-light); white-space: nowrap; transition: 0.3s; }
        .filter-chip.active { background: var(--text); color: white; }
        .portfolio-horizontal { display: flex; gap: 15px; overflow-x: auto; padding: 10px 5px; scroll-snap-type: x mandatory; -webkit-overflow-scrolling: touch; scrollbar-width: none; }
        .portfolio-horizontal::-webkit-scrollbar { display: none; }
        .case-card { flex: 0 0 160px; scroll-snap-align: start; background: #fff; border-radius: 16px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.04); animation: fadeIn 0.6s ease; display: flex; flex-direction: column; }
        .case-img-box { position: relative; width: 100%; height: 180px; background: #f0f0f0; }
        .case-img-box img { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; }
        .case-info { padding: 10px; flex-grow: 1; display: flex; flex-direction: column; justify-content: space-between;}
        .case-tags { display: flex; flex-wrap: wrap; gap: 4px; margin-bottom: 4px; }
        .case-tag { font-size: 0.6rem; padding: 2px 6px; border-radius: 4px; background: #F2F0EB; color: #7A6C63; font-weight: 600; }
        .case-desc { font-size: 0.75rem; color: #888; line-height: 1.3; }

        /* --- 4. é¡§å®¢å¥½è©• (âœ¨ æ©«å‘æ»‘å‹•å„ªåŒ–ç‰ˆ âœ¨) --- */
        .reviews-horizontal {
            display: flex; gap: 15px; overflow-x: auto; padding: 10px 5px;
            scroll-snap-type: x mandatory; -webkit-overflow-scrolling: touch; scrollbar-width: none;
        }
        .reviews-horizontal::-webkit-scrollbar { display: none; }

        .review-card-item {
            flex: 0 0 280px; /* å›ºå®šå¯¬åº¦ï¼Œè®“å®ƒè®Šæˆæ©«å‘å¡ç‰‡ */
            scroll-snap-align: center;
            background: #fff; padding: 20px; border-radius: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            border: 1px solid rgba(0,0,0,0.02);
            display: flex; flex-direction: column; gap: 10px;
        }
        
        /* è©•è«–é ­éƒ¨ï¼šé ­åƒ+åå­— */
        .review-header { display: flex; align-items: center; gap: 10px; }
        .review-avatar { 
            width: 40px; height: 40px; border-radius: 50%; background: #F2F0EB; 
            display: flex; align-items: center; justify-content: center; color: var(--primary);
        }
        .review-name { font-weight: 700; color: var(--text); font-size: 0.95rem; }
        
        /* è©•è«–å…§å®¹ */
        .review-content { 
            font-size: 0.9rem; color: #666; line-height: 1.6; 
            background: #F9F8F6; padding: 12px; border-radius: 12px;
            /* é™åˆ¶æœ€å¤šé¡¯ç¤º 4 è¡Œï¼Œè¶…éçœç•¥ */
            display: -webkit-box; -webkit-line-clamp: 4; -webkit-box-orient: vertical; overflow: hidden;
        }

        /* --- æ‡¸æµ®æŒ‰éˆ• --- */
        .floating-cta { position: fixed; bottom: 85px; left: 50%; transform: translateX(-50%); width: 85%; max-width: 350px; background: var(--text); color: white; padding: 14px; border-radius: 50px; text-align: center; text-decoration: none; font-weight: 700; font-size: 1rem; box-shadow: 0 10px 25px rgba(90, 72, 63, 0.4); z-index: 950; display: flex; align-items: center; justify-content: center; gap: 8px; }

        /* --- éª¨æ¶å± --- */
        .skeleton { background: linear-gradient(90deg, #f0f0f0 25%, #e8e8e8 50%, #f0f0f0 75%); background-size: 200% 100%; animation: skeleton-loading 1.5s infinite; border-radius: 8px; color: transparent !important; }
        @keyframes skeleton-loading { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }

        /* å½ˆçª— */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(5px); z-index: 2000; align-items: center; justify-content: center; }
        .modal-overlay.show { display: flex; animation: fadeIn 0.3s; }
        .modal-content { background: #fff; width: 90%; max-width: 450px; max-height: 85vh; overflow-y: auto; border-radius: 24px; position: relative; }
        .modal-close-btn { position: absolute; top: 15px; right: 15px; z-index: 10; background: rgba(0,0,0,0.3); color: white; width: 32px; height: 32px; border-radius: 50%; text-align: center; line-height: 32px; cursor: pointer; }
        .carousel-container { display: flex; overflow-x: auto; scroll-snap-type: x mandatory; height: 320px; background: #f0f0f0; }
        .carousel-slide { min-width: 100%; height: 100%; scroll-snap-align: center; position: relative; }
        .carousel-slide img { width: 100%; height: 100%; object-fit: cover; }
        .modal-body { padding: 25px; }

        .collapsible-content { transition: all 0.4s; max-height: 0; overflow: hidden; opacity: 0; }
        .collapsible-content.expanded { max-height: 1000px; opacity: 1; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .hidden { display: none; }

    </style>
</head>
<body>

    <!-- Hero -->
    <div class="hero-section">
        <h1 class="hero-title">AM Beauty Studio</h1>
        <div class="hero-subtitle">æ‰“é€ å¦³çš„å½ç´ é¡å°å¿ƒæ©Ÿ</div>
    </div>

    <!-- ç´‹ç¶‰å¸«å½¢è±¡å¡ -->
    <div class="profile-card">
        <img src="https://i.postimg.cc/k5n2y3Kz/avatar-placeholder.png" class="profile-img" alt="ç´‹ç¶‰å¸«">
        <div class="profile-info">
            <h3>AM ç´‹ç¶‰å¸«</h3>
            <p>å°ˆæ³¨æ–¼è‡ªç„¶æ¯›æµæ„Ÿèˆ‡å€‹äººåŒ–çœ‰å‹è¨­è¨ˆï¼Œè‡´åŠ›æ–¼è®“æ¯ä½å¥³å­©éƒ½èƒ½æ“æœ‰ç´ é¡è‡ªä¿¡ã€‚</p>
            <div class="tags-row">
                <span class="tag-pill">TNLäºŒç´šæª¢å®š</span>
                <span class="tag-pill">æ‹‹æ£„å¼è€—æ</span>
                <span class="tag-pill">SGSèªè­‰è‰²ä¹³</span>
            </div>
        </div>
    </div>

    <!-- åº•éƒ¨å°è¦½åˆ— -->
    <div class="bottom-nav">
        <a href="#search" class="nav-btn active" onclick="setActiveNav(this)">
            <svg viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
            é¦–é 
        </a>
        <a href="#services" class="nav-btn" onclick="setActiveNav(this)">
            <svg viewBox="0 0 24 24"><rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path></svg>
            æœå‹™
        </a>
        <a href="#portfolio" class="nav-btn" onclick="setActiveNav(this)">
            <svg viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>
            ä½œå“
        </a>
        <a href="#reviews" class="nav-btn" onclick="setActiveNav(this)">
            <svg viewBox="0 0 24 24"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
            å¥½è©•
        </a>
    </div>

    <div class="container">

        <!-- 1. è£œè‰²æŸ¥è©¢ -->
        <section id="search">
            <div class="search-container">
                <div class="search-icon-box">
                    <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                </div>
                <h3 style="margin:0; font-size:1.3rem; color:var(--text);">èˆŠå®¢è£œè‰²æŸ¥è©¢</h3>
                <p style="font-size:0.9rem; color:#999; margin:8px 0 0 0;">è¼¸å…¥å§“åæˆ–é›»è©±æŸ¥è©¢å°ˆå±¬å„ªæƒ </p>
                
                <div class="input-group">
                    <div class="input-icon">ğŸ”</div>
                    <input type="text" id="queryInput" class="search-input" 
                           placeholder="ä¾‹å¦‚ï¼šæ—å°ç¾ æˆ– 0912..." 
                           onkeydown="if(event.key === 'Enter') searchRecord()">
                </div>
                
                <button onclick="searchRecord()" id="searchButton" class="btn-primary">
                    ç«‹å³æŸ¥è©¢
                </button>

                <div id="messageArea" class="hidden mt-4 p-3 rounded-xl text-sm font-bold"></div>
                <div id="resultsArea" class="mt-6 text-left"></div>
            </div>
        </section>

        <!-- 2. æœå‹™é …ç›® -->
        <section id="services">
            <div class="section-header"><h2>æœå‹™é …ç›®</h2></div>
            <div id="service-text-list" class="service-list-text">
                <div class="service-card skeleton" style="height:80px;"></div>
                <div class="service-card skeleton" style="height:80px;"></div>
            </div>
        </section>

        <!-- 3. ç•™è‰²ä½œå“ (æ©«å‘æ»‘å‹•) -->
        <section id="portfolio">
            <div class="section-header" onclick="toggleSection('portfolio-content', this)">
                <h2>ç•™è‰²ä½œå“é›† <span class="header-arrow">â–¼</span></h2>
            </div>
            
            <div id="portfolio-content" class="section-collapsible">
                <div class="filter-scroller">
                    <div class="filter-chip active" onclick="filterPortfolio('all', this)">å…¨éƒ¨æ¡ˆä¾‹</div>
                    <div class="filter-chip" onclick="filterPortfolio('brow', this)">éœ§çœ‰</div>
                    <div class="filter-chip" onclick="filterPortfolio('lip', this)">éœ§å”‡</div>
                    <div class="filter-chip" onclick="filterPortfolio('dark', this)">çƒå”‡è½‰è‰²</div>
                </div>

                <div id="portfolio-horizontal" class="portfolio-horizontal">
                    <div class="case-card skeleton" style="width:160px; height:220px; flex-shrink:0;"></div>
                    <div class="case-card skeleton" style="width:160px; height:220px; flex-shrink:0;"></div>
                </div>
            </div>
        </section>

        <!-- 4. é¡§å®¢å¥½è©• (âœ¨ å·²ä¿®æ­£ç‚ºæ©«å‘æ»‘å‹• âœ¨) -->
        <section id="reviews">
            <div class="section-header"><h2>é¡§å®¢å¥½è©•</h2></div>
            <!-- å®¹å™¨æ”¹ç‚º reviews-horizontal -->
            <div id="review-list" class="reviews-horizontal">
                <!-- é è¨­éª¨æ¶ -->
                <div class="review-card-item skeleton" style="height:150px;"></div>
                <div class="review-card-item skeleton" style="height:150px;"></div>
            </div>
        </section>

    </div>

    <!-- æ‡¸æµ®é ç´„æŒ‰éˆ• -->
    <a id="floatBookingBtn" href="#" class="floating-cta">
        <span>ğŸ“… ç«‹å³é ç´„è«®è©¢</span>
    </a>

    <!-- å½ˆçª— -->
    <div id="serviceModal" class="modal-overlay" onclick="closeModal(event)">
        <div class="modal-content">
            <div class="modal-close-btn" onclick="closeModal(event)">&times;</div>
            <div id="carouselContainer" class="carousel-container"></div>
            <div class="modal-body">
                <h2 id="modalTitle" style="font-size:1.4rem; font-weight:bold; color:var(--text);"></h2>
                <div id="modalPrice" style="color:#C17E7E; font-weight:bold; font-size:1.2rem; margin:5px 0;"></div>
                <div id="modalDesc" style="margin-top:15px; color:#555; background:#F9F8F6; padding:15px; border-radius:12px; line-height:1.6; font-size:0.95rem; white-space:pre-wrap;"></div>
                <button onclick="document.getElementById('floatBookingBtn').click()" class="btn-primary" style="margin-top:20px; background:var(--text); box-shadow:none;">é ç´„æ­¤é …ç›®</button>
            </div>
        </div>
    </div>

    <script>
        // â–¼â–¼â–¼ è¨­å®šå€ (ç¶²å€çš†æ­£ç¢º) â–¼â–¼â–¼
        const SERVICES_CSV = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTcHgH5o_qBPjXeQfKA74-D0lmpJr6TjGGR_BbID5UsFM6YCXqoQAFC7my8Bo1XQoHcJdgC4rk08ORY/pub?gid=1138837231&single=true&output=csv';
        const REVIEWS_CSV = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTcHgH5o_qBPjXeQfKA74-D0lmpJr6TjGGR_BbID5UsFM6YCXqoQAFC7my8Bo1XQoHcJdgC4rk08ORY/pub?gid=174294022&single=true&output=csv'; 
        const PORTFOLIO_CSV = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTcHgH5o_qBPjXeQfKA74-D0lmpJr6TjGGR_BbID5UsFM6YCXqoQAFC7my8Bo1XQoHcJdgC4rk08ORY/pub?gid=1127370948&single=true&output=csv'; 
        const SETTINGS_CSV = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQxxxxxxxx/pub?output=csv'; 
        const GAS_API_URL = "https://script.google.com/macros/s/AKfycbx6grwl5DidK6DScAaZLM8udp-Pjn_FrB33bv6ES0JkwAiiIx-xxJHicxANVGH7caSpEg/exec"; 
        
        let allPortfolioData = [];
        let currentPortfolioData = [];

        document.addEventListener("DOMContentLoaded", function() {
            loadServices(); loadReviews(); loadPortfolio(); loadSettings();
        });

        // å°èˆªåˆ‡æ›
        function setActiveNav(btn) {
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }

        // å€å¡Šæ”¶åˆ
        function toggleSection(contentId, headerEl) {
            const content = document.getElementById(contentId);
            content.classList.toggle('collapsed');
            headerEl.classList.toggle('collapsed');
        }

        function parseCSV(str) {
            const arr = []; let quote = false; let col = 0, row = 0;
            for (let c = 0; c < str.length; c++) {
                let cc = str[c], nc = str[c+1];
                arr[row] = arr[row] || []; arr[row][col] = arr[row][col] || '';
                if (cc == '"' && quote && nc == '"') { arr[row][col] += '"'; ++c; continue; }
                if (cc == '"') { quote = !quote; continue; }
                if (cc == ',' && !quote) { ++col; continue; }
                if (cc == '\r' && nc == '\n' && !quote) { ++row; col = 0; ++c; continue; }
                if (cc == '\n' && !quote) { ++row; col = 0; continue; }
                if (cc == '\r' && !quote) { ++row; col = 0; continue; }
                arr[row][col] += cc;
            }
            return arr;
        }

        // --- 1. è¼‰å…¥æœå‹™ ---
        function loadServices() {
            fetch(SERVICES_CSV).then(r=>r.text()).then(txt=>{
                const rows = parseCSV(txt);
                const list = document.getElementById('service-text-list');
                list.innerHTML = '';
                let start = (rows.length>0 && rows[0][0].toLowerCase().includes('name')) ? 1 : 0;
                for(let i=start; i<rows.length; i++){
                    const c = rows[i]; if(c.length<2 || !c[0]) continue;
                    const div = document.createElement('div');
                    div.className = 'service-card';
                    div.innerHTML = `<div><h3 style="margin:0;font-size:1.05rem;color:var(--text);">${c[0]}</h3><span style="font-size:0.8rem;color:#999;">${c[2]||'æŸ¥çœ‹è©³æƒ…'}</span></div><div style="font-weight:700;color:#C17E7E;">NT$ ${c[1]}</div>`;
                    div.onclick = () => openServiceModal(c[0], c[1], c[4], c[3]);
                    list.appendChild(div);
                }
            });
        }
        function openServiceModal(n, p, d, imgs) {
            document.getElementById('modalTitle').textContent = n;
            document.getElementById('modalPrice').textContent = 'NT$ ' + p;
            document.getElementById('modalDesc').textContent = d ? d.replace(/\|/g, '\n') : 'æš«ç„¡ä»‹ç´¹';
            const c = document.getElementById('carouselContainer'); c.innerHTML = '';
            if(imgs) imgs.split(';').forEach(src=>{ if(src.trim()) c.innerHTML += `<div class="carousel-slide"><img src="${src.trim()}"></div>`; });
            c.style.display = imgs ? 'flex' : 'none';
            document.getElementById('serviceModal').classList.add('show');
            document.body.style.overflow = 'hidden';
        }
        function closeModal(e) { 
            const m = document.getElementById('serviceModal'); 
            if(e.target===m || e.target.classList.contains('modal-close-btn')) {
                m.classList.remove('show'); document.body.style.overflow = '';
            }
        }

        // --- 2. è¼‰å…¥ä½œå“ (æ©«å‘) ---
        function loadPortfolio() {
            fetch(PORTFOLIO_CSV).then(r=>r.text()).then(txt=>{
                const rows = parseCSV(txt); allPortfolioData = [];
                let start = (rows.length>0 && rows[0][0].toLowerCase().includes('image')) ? 1 : 0;
                for(let i=start; i<rows.length; i++){
                    const c = rows[i]; if(!c[0]) continue;
                    allPortfolioData.push({ img: c[0], desc: c[1]||'', cat: (c[2]||'').trim().toLowerCase() });
                }
                currentPortfolioData = allPortfolioData;
                renderPortfolio();
            });
        }
        function filterPortfolio(cat, btn) {
            document.querySelectorAll('.filter-chip').forEach(b => b.classList.remove('active'));
            if(btn) btn.classList.add('active');
            currentPortfolioData = (cat === 'all') ? allPortfolioData : allPortfolioData.filter(i => i.cat === cat);
            renderPortfolio();
        }
        function renderPortfolio() {
            const container = document.getElementById('portfolio-horizontal'); 
            container.innerHTML = '';
            if(currentPortfolioData.length === 0) { container.innerHTML = '<p style="text-align:center;color:#ccc;width:100%;">æš«ç„¡ä½œå“</p>'; return; }
            
            currentPortfolioData.forEach(item => {
                const parts = item.desc.split('|');
                const tag = parts.length > 1 ? parts[0].trim() : '';
                const text = parts.length > 1 ? parts[1].trim() : parts[0].trim();
                const div = document.createElement('div'); div.className = 'case-card';
                div.innerHTML = `<div class="case-img-box"><img src="${item.img}" loading="lazy"></div><div class="case-info">${tag ? `<div class="case-tags"><span class="case-tag">${tag}</span></div>` : ''}<div class="case-desc">${text}</div></div>`;
                container.appendChild(div);
            });
        }

        // --- 3. è¼‰å…¥å¥½è©• (âœ¨ æ©«å‘æ»‘å‹•) ---
        function loadReviews() {
            fetch(REVIEWS_CSV).then(r=>r.text()).then(txt=>{
                const rows = parseCSV(txt);
                const list = document.getElementById('review-list');
                list.innerHTML = ''; 
                let start = (rows.length>0 && rows[0][0].toLowerCase().includes('name')) ? 1 : 0;
                
                for(let i=start; i<rows.length; i++){
                    const c = rows[i]; 
                    if(c.length<3 || !c[0]) continue; // å¯¬å®¹æª¢æŸ¥
                    const name = c[0] || 'é¡§å®¢';
                    const content = c[2] || ''; 
                    
                    const div = document.createElement('div');
                    div.className = 'review-card-item';
                    div.innerHTML = `
                        <div class="review-header">
                            <div class="review-avatar">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                            </div>
                            <span class="review-name">${name}</span>
                        </div>
                        <div class="review-content">${content}</div>
                    `;
                    list.appendChild(div);
                }
            }).catch(()=> document.getElementById('review-list').innerHTML='<p style="text-align:center;color:#ccc">å°šç„¡è©•è«–</p>');
        }

        // --- è¨­å®šèˆ‡æŸ¥è©¢ ---
        function loadSettings() {
            fetch(SETTINGS_CSV).then(r=>r.text()).then(csv => {
                csv.split('\n').forEach(row => {
                    const [id, content] = row.split(',');
                    if(id && id.trim() === 'link_booking') document.getElementById('floatBookingBtn').href = content.trim();
                });
            });
        }
        function searchRecord() {
            const q=document.getElementById('queryInput').value.trim();
            if(!q) return displayMessage('error','è«‹è¼¸å…¥è³‡æ–™');
            const btn=document.getElementById('searchButton'); const area=document.getElementById('resultsArea');
            btn.textContent='æŸ¥è©¢ä¸­...'; btn.disabled=true; area.innerHTML='';
            fetch(`${GAS_API_URL}?q=${encodeURIComponent(q)}`).then(r=>r.json()).then(res=>{
                if(res.data && res.data.length){ displayMessage('success',`æ‰¾åˆ° ${res.data.length} ç­†`); area.innerHTML=res.data.map((r,i)=>createCard(r,i)).join(''); }
                else displayMessage('info','æŸ¥ç„¡è³‡æ–™');
            }).finally(()=>{ btn.textContent='ç«‹å³æŸ¥è©¢'; btn.disabled=false; });
        }
        function displayMessage(t, c) { const m=document.getElementById('messageArea'); m.textContent=c; m.className=`mt-4 p-3 rounded-xl text-sm font-bold ${t==='error'?'bg-red-50 text-red-600':'bg-green-50 text-green-600'}`; m.classList.remove('hidden'); }
        function checkIsExpired(d) { if(!d)return false; return new Date() > new Date(d); }
        function maskPhoneNumber(p) { if(!p)return''; let s=String(p).replace(/'/g,'').trim(); return s.length<8?s:s.substring(0,4)+'***'+s.substring(s.length-3); }
        function toggleCollapse(btn, id) { const el=document.getElementById(id); el.classList.toggle('expanded'); btn.querySelector('.btn-text').textContent=el.classList.contains('expanded')?'æ”¶èµ·':'æŸ¥çœ‹å®Œæ•´åƒ¹ç›®è¡¨'; }
        
        function getPriceCardHtml(info, useOrange) { 
            if (!info) return ''; 
            let p = info.price===0?'å…è²»':(info.price?`NT$ ${info.price}`:'æ´½è©¢'); 
            let bg = info.price===0?'bg-green-600':(useOrange?'bg-orange-500':'bg-pink-500'); 
            let theme = info.price===0?'bg-green-50 border-green-200':(useOrange?'bg-orange-50 border-orange-200':'bg-pink-50 border-pink-200'); 
            let dateText = (info.dateRange || '').replace(/ã€.*?ã€‘/g, '');
            return `
            <div class="mt-3 p-3 rounded-xl border ${theme} flex justify-between items-center shadow-sm">
                <div>
                    <h3 class="text-xs font-bold text-gray-400 mb-1">ç›®å‰è£œè‰²åƒ¹æ ¼</h3>
                    <p class="text-sm font-bold text-gray-800 tracking-wide">${dateText}</p>
                </div>
                <span class="px-3 py-1 text-white text-lg font-bold rounded-lg ${bg} shadow-sm">${p}</span>
            </div>`; 
        }
        
        function createCard(r, i) { 
            const cid=`d-${i}`; const ranges=(r.touchUpRanges||[]).map(t=>`<div class="flex justify-between py-2 border-b border-gray-100 text-sm"><span>${t.dateRange}</span><span class="font-bold text-gray-700">${t.price===0?'å…è²»':'$'+t.price}</span></div>`).join(''); 
            return `
            <div class="result-card">
                <div class="result-header">
                    <div><div class="result-name">${r.name}</div><span class="text-gray-400 text-sm">(${maskPhoneNumber(r.phone)})</span></div>
                </div>
                
                <div class="info-badges">
                    <div class="info-badge"><span class="info-label">ä¸Šæ¬¡æ—¥æœŸ</span><span class="info-value">${r.lastDate||'-'}</span></div>
                    <div class="info-badge"><span class="info-label">ä¸Šæ¬¡é …ç›®</span><span class="info-value highlight">${r.service}</span></div>
                </div>

                ${r.specialReminder?`<div class="bg-yellow-50 text-yellow-800 p-2.5 rounded-lg text-xs mb-3 font-medium">ğŸ’¡ ${r.specialReminder}</div>`:''} 
                ${getPriceCardHtml(r.currentPriceInfo, r.eyebrowDiscountDate && !checkIsExpired(r.eyebrowDiscountDate))} 
                
                <div class="mt-4">
                    <button onclick="toggleCollapse(this,'${cid}')" class="w-full py-2 bg-gray-50 text-gray-500 text-xs font-bold rounded-lg transition hover:bg-gray-100"><span class="btn-text">æŸ¥çœ‹å®Œæ•´åƒ¹ç›®è¡¨</span></button>
                    <div id="${cid}" class="collapsible-content bg-gray-50 px-3 mt-1 rounded-b-lg"><div class="py-2">${ranges}</div></div>
                </div>
            </div>`; 
        }
    </script>
</body>
</html>
